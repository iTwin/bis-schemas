workspace:
  clean: all

trigger:
  branches:
    include:
     - master
  paths:
    include:
     - '*.ecschema.xml'
     - '*.remarks.md'

pool:
  name: iModelTechCI
  demands:
  - Agent.OS -equals Windows_NT
  - npm
variables:
  - group: azure-artifacts-npm-token
  - name: validationOut
    value: '$(Agent.BuildDirectory)/ValidationResults'

steps:
  - task: NodeTool@0
    displayName: 'Use Node 10.15.0'
    inputs:
      versionSpec: 10.15.0
  - checkout: self
    clean: true

   
  - powershell: |
      $npmrcDir = "$(Build.Repository.LocalPath)"
      
      if(!(Test-Path -Path $npmrcDir)){
          mkdir $npmrcDir
      }
      
      $npmrcFile = $npmrcDir + "/.npmrc"
      
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "@bentley:registry=/"
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "always-auth=true" -Append
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "///bentleycs/_packaging/Packages/npm/registry/:username=Packages" -Append
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "///bentleycs/_packaging/Packages/npm/registry/:_password=$(artifactsRegistryToken)" -Append
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "///bentleycs/_packaging/Packages/npm/registry/:email=npm requires email to be set but doesn't use the value" -Append
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "///bentleycs/_packaging/Packages/npm/:username=Packages" -Append
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "///bentleycs/_packaging/Packages/npm/:_password=$(artifactsRegistryToken)" -Append
      Out-File -FilePath $npmrcFile -Encoding ascii -InputObject "///bentleycs/_packaging/Packages/npm/:email=npm requires email to be set but doesn't use the value" -Append

   

  - script: npm install -g @bentley/schema-validator
    displayName: 'Install schema-validator'
  - script: node ./tools/validation/SchemaValidationRunner.js --BisRoot --OutDir $(validationOut)
    displayName: Perform BIS Schema Validation

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: $(validationOut) 
      includeRootFolder: false 
      archiveType: 7z
      archiveFile: '$(Build.ArtifactStagingDirectory)/ValidationResults_$(Build.BuildId).zip' 
      replaceExistingArchive: true 

    #- publish: $(validationOut)
    #  artifact: bis-schema-validation-logs
    #  displayName: 'Publish BIS Schema Validation Results'